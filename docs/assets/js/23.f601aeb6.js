(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{590:function(s,t,e){"use strict";e.r(t);var n=e(17),a=Object(n.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"需求"}},[s._v("需求")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("在不同地点的网络设备虚拟组网")])]),s._v(" "),e("li",[e("p",[s._v("虚拟网络中各设备可以访问"),e("code",[s._v("172.16.60.0/23")]),s._v("内网网段设备")])])]),s._v(" "),e("h2",{attrs:{id:"创建zerotier虚拟网络"}},[s._v("创建ZeroTier虚拟网络")]),s._v(" "),e("p",[s._v("参考"),e("a",{attrs:{href:"https://docs.zerotier.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),e("OutboundLink")],1)]),s._v(" "),e("h2",{attrs:{id:"配置moon节点"}},[s._v("配置moon节点")]),s._v(" "),e("p",[s._v("直接通过ZeroTier官方节点建立网络连接延迟太高，使用本地服务器建立moon节点进行加速。")]),s._v(" "),e("ol",[e("li",[s._v("基础配置")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装zerotier-one")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s https://install.zerotier.com "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入创建好的虚拟网络")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" zerotier-cli "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" xxxxxxxx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("在ZeroTier Central网络管理的Members中选择该设备进行授权，并勾选"),e("code",[s._v("Allow Ethernet Bridging")]),s._v("。")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("生成并应用moon配置")])]),s._v(" "),e("p",[s._v("参考"),e("a",{attrs:{href:"https://docs.zerotier.com/roots",target:"_blank",rel:"noopener noreferrer"}},[s._v("Private Root Servers"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成moon配置文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/lib/zerotier-one\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" zerotier-idtool initmoon identity.public "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" moon.json\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编辑配置文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 将"stableEndpoints": [] 修改成 "stableEndpoints": ["ServerIP/9993"]，ServerIP是服务器的公网IP')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成moon文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" zerotier-idtool genmoon moon.json\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看生成的moon文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /var/lib/zerotier-one\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用moon文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" moons.d\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" 000000xxxxxxxxxx.moon moons.d\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" zerotier-one restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("使用moon节点")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" zerotier-cli orbit xxxxxxxxxx xxxxxxxxxx\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里xxxxxxxxxx是前面生成的moon文件除了那些0之外的部分，即节点ID")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("如何检查是否成功应用moon节点")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" zerotier-cli listpeers\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("该命令会输出一行有关moon的信息，如果没有成功应用，应该类似于"),e("code",[s._v("200 listpeers xxxxxxxxx - -1 - MOON")]),s._v("，通常情况下是防火墙的问题，需要打开"),e("code",[s._v("9993/udp")]),s._v("，包括服务器防火墙、运营商安全组之类的。")]),s._v(" "),e("p",[s._v("也可以通过虚拟网络中设备相互ping看延迟检查，如果成功应用moon节点，相互ping的延迟最坏情况下是比各自ping moon节点延迟之和略高几ms。以我的网络为例，A设备与moon节点ping约30ms，B设备与moon节点ping约20ms，无moon节点时AB互ping约300+ms，moon节点生效时互ping约30+ms。")]),s._v(" "),e("h2",{attrs:{id:"与物理网络组网"}},[s._v("与物理网络组网")]),s._v(" "),e("p",[s._v("参考"),e("a",{attrs:{href:"https://docs.zerotier.com/route-between-phys-and-virt#configure-iptables",target:"_blank",rel:"noopener noreferrer"}},[s._v("Route between ZeroTier and Physical Networks"),e("OutboundLink")],1)]),s._v(" "),e("ol",[e("li",[s._v("网络说明")])]),s._v(" "),e("p",[s._v("希望加入了ZeroTier虚拟网络的设备可以访问"),e("code",[s._v("172.16.60.0/23")]),s._v("内网网段设备，该网段的默认网关及其它设备的配置无法修改，我有一台可以作为跳板机的内网服务器。")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("配置ZeroTier虚拟网络")])]),s._v(" "),e("p",[s._v("配置ZeroTier自动分配ipv4地址池为"),e("code",[s._v("172.16.58.0")]),s._v("到"),e("code",[s._v("172.16.59.254")]),s._v("。在ZeroTier Central的网络管理中，添加route：destination为"),e("code",[s._v("172.16.58.0/23")]),s._v("，空置via，提交后显示"),e("code",[s._v("172.16.58.0/23 (LAN)")]),s._v("。")]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("配置内网服务器")])]),s._v(" "),e("p",[s._v("在内网服务器上安装zerotier-one并加入虚拟网络，在ZeroTier Central网络管理的Members中选择该网络进行授权，并勾选"),e("code",[s._v("Allow Ethernet Bridging")]),s._v("。")]),s._v(" "),e("p",[s._v("假定该服务器的地址为"),e("code",[s._v("172.16.58.58")]),s._v("，它在内网中的地址为"),e("code",[s._v("172.16.61.61")]),s._v("。此时应该可以从moon节点使用"),e("code",[s._v("172.16.58.58")]),s._v("正常访问到该内网服务器。")]),s._v(" "),e("p",[s._v("在ZeroTier Central的网络管理中，添加route：destination为"),e("code",[s._v("172.16.60.0/22")]),s._v("，via为"),e("code",[s._v("172.16.58.58")]),s._v("，提交后显示"),e("code",[s._v("172.16.58.0/23 via 172.16.58.58")]),s._v("。")]),s._v(" "),e("p",[e("strong",[s._v("注意！！！这里的掩码必须要大于该网络本来的掩码！！！")]),s._v(" 官方解释如下：")]),s._v(" "),e("blockquote",[e("p",[s._v("Configure the destination route as slightly larger than the actual physical subnet, here /23 instead of /24 (a smaller number is a bigger subnet in this notation) This makes devices that are on both the physical and the ZeroTier network prefer the physical connection.")])]),s._v(" "),e("p",[s._v("回到内网服务器配置NAT：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看网络接口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 找到172.16.58.58对应的ztxxxx，以及172.16.61.61对应的enpxxxx")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PHY_IFACE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("enpxxxx\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ZT_IFACE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ztxxxx\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置NAT")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables -t nat -A POSTROUTING -o "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PHY_IFACE")]),s._v(" -j MASQUERADE\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables -A FORWARD -i "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PHY_IFACE")]),s._v(" -o "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ZT_IFACE")]),s._v(" -m state --state RELATED,ESTABLISHED -j ACCEPT\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables -A FORWARD -i "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ZT_IFACE")]),s._v(" -o "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PHY_IFACE")]),s._v(" -j ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("持久化路由表，使重启有效：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久化")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" iptables-persistent\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份iptables")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/iptables/rules.v4 /etc/iptables/rules.v4.bak\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新路由表")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -c "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iptables-save > /etc/iptables/rules.v4"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("至此，所有加入ZeroTier的设备均可以直接访问"),e("code",[s._v("172.16.60.0/23")]),s._v("网段的内网设备了。但是如果内网设备想访问"),e("code",[s._v("172.16.58.0/23")]),s._v("网段设备，仍然需要加入ZeroTier虚拟网络。")])])}),[],!1,null,null,null);t.default=a.exports}}]);